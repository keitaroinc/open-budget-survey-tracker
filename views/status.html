{% extends "layout.html" %}
{% import "helpers.html" as h %}

{% block page_title %}{{ country.country + gettext(" - Open Budget Survey - Tracker") }}{% endblock %}

{% block content %}

<div class="row">
  <div class="col-md-9">
    <h1>{{ gettext(country.country) }}</h1>

    {% if country.obi_scores %}
    <div>
      <h2>{{ gettext("Open Budget Index") }} <small><a href="/about"><span class="glyphicon glyphicon-question-sign" aria-hidden="true"></span></a></h2>
      <p>
	{{ country.obi_scores|last.score }}/100
	({{ country.obi_scores|last.year }})
      </p>
    </div>
    {% endif %}
  </div>
  <div class="col-md-3">
    <div class="row top20">
      <a href="{{ country.library }}" target="_blank" class="btn btn-primary col-md-12">{{ gettext("View the Budget Library") }}</a>
    </div>
    <div class="row top5">
      <a href="/country/{{ country.country }}" class="btn btn-primary col-md-12">{{ gettext("View historical information") }}</a>
    </div>
  </div>
</div>

<h2>{{ gettext("Current Status") }}</h2>
<table class="table table-hover status-table">
  <colgroup>
    <col width="20%">
    <col width="8%">
    <col width="22%">
    <col width="20%">
    <col width="30%">
  </colgroup>
  <thead>
    <tr>
      <th>{{ gettext("Document") }}</th>
      <th>{{ gettext("Fiscal Year") }}</th>
      <th>{{ gettext("Current Status") }}</th>
      <th>{{ gettext("Date of Publication") }}</th>
      <th><span class="text-muted">{{ gettext("Next Publishing Period") }}</span></th>
    </tr>
  </thead>
  <tbody>
    {% for doc in docs %}
      {% set cell = undefined %}
      {% set fiscal_year = '-' %}
      {% for year in country.documents|reverse %}
        {% if not cell %}
          {% if doc.title in country.documents[year] %}
            {% set fiscal_year = year %}
            {% set cell = country.documents[year][doc.title]|first %}
          {% endif %}
        {% endif %}
      {% endfor %}
    <tr>
      <th scope="row" data-toggle="popover" data-placement="top" data-content="{{ gettext(doc.description) }}"{% if lang == 'es' %} style="font-size:90%;"{% endif %}{% if lang == 'ru' %} style="font-size:70%;"{% endif %}>
        {{ gettext(doc.title) }}
      </th>
      <td>{{ date_format({'year':fiscal_year}, 'YYYY') }}</td>
      {% if cell %}
      <td>
        <span class="badge state state-{{ cell.state|replace(' ', '-') }}">
          <span>{{ h.state(cell.state) }}</span>
        </span>
        {{ h.state(cell.state) }}
      </td>
      <td>
        {% if cell.date_published %}
          {{ date_format(Date.parse(cell.date_published), 'll') }}
        {% else %}
        <span class="text-muted">
          {{ gettext("Unavailable") }}
        </span>
        {% endif %}
      </td>
      {% else %}
      <td>
        <span class="badge state state-not-produced">
          <span>{{ h.state("not produced") }}</span>
        </span>
        {{ h.state("not produced") }}
      </td>
      <td>
        <span class="text-muted">{{ gettext("Unavailable") }}</span>
      </td>
      {% endif %}
      <td>
        <span class="text-muted">
          {#
          Special cases:
          * In-Year Report
          * Citizens Budget
	  
          For these next publication should just be described with
          static text since they cannot be computed and are dependent
          on each government's budget cycle.
          #}
          {% set static_expected = {
          'in-year report': gettext('Publishing period for each report is one to three months after a particular month/quarter ends.'),
          "citizens budget": gettext('Same as either the Executive Budget Proposal or Enacted Budget.') }
          %}
          {% if doc.title|lower in static_expected %}
            {{ static_expected[doc.title|lower] }}
          {% else %}
            {% set search_dates_found = false %}
            {% for site in country.sites %}
              {% if !search_dates_found && site.type == doc.title %}
                {% set start_date = Date.parse(site.search_dates.start) %}
                {% set end_date = Date.parse(site.search_dates.end) %}
                {% if end_date >= Date.now() %}
                  {%- if start_date < Date.now() %}
                    {{ i18nformat(gettext('Before %s'), [date_format(Date.parse(site.search_dates.end), 'll')]) }}
                  {%- else %}
                    {{ date_format(Date.parse(site.search_dates.start), 'll') }} - {{ date_format(Date.parse(site.search_dates.end), 'll') }}
                  {% endif %}
                  {% set search_dates_found = true %}
                {% endif %}
              {% endif %}
            {% endfor %}
            {% if !search_dates_found %}
              {{ gettext("Unavailable") }}
            {% endif %}
          {% endif %}
	</span>
      </td>
    </tr>
    {% if cell.comments %}
    <tr>
      <td class="table-comments" colspan="5">
	<small>
	  {{ cell.comments }}
	</small>
      </td>
    </tr>
    {% endif %}
    {% endfor %}
  </tbody>
</table>

